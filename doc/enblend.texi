\input auxmac
\input texinfo


@c
@c Header
@c

@c %**start of header
@setfilename enblend.info
@settitle Combining Multiple Images with Enblend@tie{}@value{VERSION}
@include auxmac.texi
@include versenblend.texi

@c Define a new index for options.
@defcodeindex op
@c %**end of header


@c
@c Categorization for the GNU Info System
@c

@dircategory Individual utilities

@direntry
* enblend: (enblend).                   Blend images using a multiresolution spline.
@end direntry


@c
@c Summary Description and Copyright
@c

@copying
This manual is for Enblend (version@tie{}@value{VERSION},
@value{UPDATED}), a tool for compositing images in such a way that the
seam between the images is invisible, or at least very difficult to
see.

Copyright @copyright{} 2004--2009 @sc{Andrew Mihal}.

@quotation
Permission is granted to copy, distribute and/or modify this document
under the terms of the @acronym{GNU} Free Documentation License,
Version@tie{}1.2 or any later version published by the Free Software
Foundation; with no Invariant Sections, no Front-Cover Texts and no
Back-Cover Texts.  A copy of the license is included in the section
entitled ``@acronym{GNU} Free Documentation License''.
@end quotation
@end copying


@c
@c Title Page and Copyright
@c

@titlepage
@title Enblend
@subtitle Combining Multiple Images
@subtitle with Enblend version @value{VERSION}, @value{UPDATED}

@author Andrew Mihal

@page
@vskip 0pt plus 1fill
@insertcopying
@end titlepage


@c @ifnothtml
@c @summarycontents
@c @end ifnothtml
@contents


@c For the TeX output the List-of-Tables and List-of-Figures appear
@c right after the Table-of-Contents.  In all other formats they go
@c right before the indices.
@iftex
@c Adjust page number so that we get roman numerals for the
@c List-of-Tables and List-of-Figures.  This screws up Texinfo's page
@c count so that we must undo it later.
@tex
\global\pageno=-4
@end tex

@unnumbered List of Tables
@listoffloats Table


@unnumbered List of Figures
@listoffloats Figure
@end iftex


@c
@c ``Top'' Node and Master Menu
@c

@ifnottex
@node Top
@top Enblend

This manual is for Enblend (version@tie{}@value{VERSION},
@value{UPDATED}), a tool for compositing images in such a way that the
seam between the images is invisible, or at least very difficult to
see.
@end ifnottex

@menu
* Overview::                    Overview of Enblend's features
* Workflow::                    Enblend's role in making panoramas
* Invocation::                  Command line options and arguments
* Understanding Masks::         How to interpret masks and mask files
* Tuning Memory Usage::         Balancing @acronym{RAM} and swap
* Helpful Programs::            Useful other programs
* Authors::                     Major Contributors
* FDL::                         @acronym{GNU} Free Documentation License
* Program Index::               Names of programs referenced
* Option Index::                Index of all options
* General Index::               Topic index
@end menu


@c
@c Document Body
@c

@node Overview
@chapter Overview

@c Undo the roman page numbering we used for the Table-of-Contents,
@c the List-of-Tables, and the List-of-Figures.
@tex
\global\pageno=1
@end tex

@cindex overview

@cindex Burt-Adelson multiresolution spline
Enblend overlays multiple @acronym{TIFF} images using the
@sc{Burt}-@sc{Adelson} multiresolution spline
algorithm.@footnote{@sc{Peter J. Burt} and @sc{Edward H. Adelson}, ``A
Multiresolution Spline With Application to Image Mosaics'',
@acronym{ACM} Transactions on Graphics, @abbr{Vol@.} 2, @abbr{No@.} 4,
October 1983, pages 217--236.}  This technique tries to make the seams
between the input images invisible.  The basic idea is that image
features should be blended across a transition zone proportional in
size to the spatial frequency of the features.  For example, objects
like trees and windowpanes have rapid changes in color.  By blending
these features in a narrow zone, you will not be able to see the seam
because the eye already expects to see color changes at the edge of
these features.  Clouds and sky are the opposite.  These features have
to be blended across a wide transition zone because any sudden change
in color will be immediately noticeable.

Enblend expects each input file to have an alpha channel.  The alpha
channel should indicate the region of the file that has valid image
data.  Enblend compares the alpha regions in the input files to find
the areas where images overlap.  Alpha channels can be used to
indicate to Enblend that certain portions of an input image should not
contribute to the final image.

@pindex hugin
@pindex PanoTools
@cindex feathering, detrimental effect of
Enblend does @emph{not} align images.  Use a tool as @command{hugin}
or PanoTools to do this.  The @acronym{TIFF} files produced by these
programs are exactly what Enblend is designed to work with.  Sometimes
these @acronym{GUI}s allow you to select feathering for the edges of
your images.  This treatment is detrimental to Enblend.  Turn off
feathering by deselecting it or setting the feather width to zero.

Enblend blends the images in the order they are specified on the
command line.  You should order your images according to the way that
they overlap, for example from left-to-right across the panorama.  If
you are making a multi-row panorama, we recommend blending each
horizontal row individually, and then running Enblend a last time to
blend all of the rows together vertically.

Find out more about Enblend on its
@uref{http://@/enblend.sourceforge.net/, web page}.


@node Workflow
@chapter Workflow
@cindex workflow

@include workflow.texi


@node Invocation
@chapter Invocation
@cindex invocation

@command{enblend} [@var{OPTIONS}] [@code{--output=}@var{IMAGE}]
@var{INPUT}@enddots{}

@noindent
Assemble the sequence of images @var{INPUT}@dots{} into a single
@var{IMAGE}.

@menu
* Common Options::              General options
* Extended Options::            Memory and GPU control
* Mask Generation Options::     Mask generation control
@end menu


@node Common Options
@section Common Options
@cindex options, common

Common options control some overall features of Enblend.

@table @code
@item -a
@opindex -a
Pre-assemble non-overlapping images before each blending iteration.

This overrides the default behavior which is to blend the images
sequentially in the order given on the command line.  Enblend will use
fewer blending iterations, but it will do more work in each iteration.

@item --compression=@var{COMPRESSION}
@opindex --compression
@cindex output file compression
@cindex compression
Write a compressed output file.

Depending on the output file format Enblend accepts different values
for @var{COMPRESSION}.

@table @asis
@item @acronym{JPEG}
@cindex @acronym{JPEG} compression
@cindex compression, @acronym{JPEG}
@var{COMPRESSION} is a @acronym{JPEG} quality level ranging from
0--100.

@item @acronym{TIFF}
@var{COMPRESSION} is one of the keywords:

@table @samp
@item NONE
Do not compress.  This is the default.

@item DEFLATE
@cindex deflate compression
@cindex compression, deflate
Use the Deflate compression scheme also called
@acronym{ZIP}-in-@acronym{TIFF}.  Deflate is a lossless data
compression algorithm that uses a combination of the @acronym{LZ77}
algorithm and @sc{Huffman} coding.

@item LZW
@cindex @acronym{LZW} compression
@cindex compression, @acronym{LZW}
Use @sc{Lempel}-@sc{Ziv}-@sc{Welch} (@acronym{LZW}) adaptive
compression scheme.  @acronym{LZW} compression is lossless.

@item PACKBITS
@cindex packbits compression
@cindex compression, packbits
Use PackBits compression scheme.  PackBits is particular variant of
run-length compression.  It is lossless.
@end table

@item Any other format
Other formats do not accept a @var{COMPRESSION} setting.

However, @uref{http://@/hci.iwr.uni-heidelberg.de/@/vigra/,
@acronym{VIGRA}} automatically compresses @file{png}-files with the
``deflate'' method.
@end table

@item -h
@itemx --help
@opindex -h
@opindex --help
Print information on the available options and exit.

@item -l @var{LEVELS}
@opindex -l
@cindex pyramid levels
@cindex levels, pyramid
Use exactly this many @var{LEVELS} for pyramid @footnote{As
Dr.@tie{}Daniel Jackson correctly
@uref{http://stargate.wikia.com/@/wiki/@/The_Tomb, noted}, actually,
it is not a pyramid: ``Ziggaurat, it's a
@uref{http://en.wikipedia.org/@/wiki/@/Ziggaurat, Ziggaurat}.''}
blending.

This option allows to trade off quality of results for slightly
shorter execution time and lower memory usage.  The default is to use
as many levels as is possible given the size of the overlap regions.
Enblend may still use a smaller number of levels if the geometry of
the images demands.

@item -o
@itemx --output=@var{FILE}
@opindex -o
@opindex --output
Place output in @var{FILE}.

@cindex @file{a.tif}
@cindex default output filename
@cindex output filename, default
If @option{--output} is not specified, the default is to put the
resulting image in @file{a.tif}.

@item -v
@itemx --verbose[=@var{LEVEL}]
@opindex -v
@opindex --verbose
Without an argument increase the verbosity of progress reporting.
Giving more @option{--verbose}@tie{}options will make Enblend more
verbose.  Directly set a verbosity level with a non-negative integral
@var{LEVEL}.

Each level includes all messages of the lower levels.

@table @asis
@item Level
Messages

@item 0
only warnings and errors

@item 1
reading and writing of images

@item 2
mask generation, pyramid, and blending

@item 3
color conversions

@item 4
image sizes, bounding boxes and intersection sizes

@item 5
detailed information on the optimizer runs (Enblend only)

@item 6
estimations of required memory in selected processing steps
@end table

The default verbosity level of Enblend is 1.

@item -V
@itemx --version
@opindex -V
@opindex --version
Output information on the Enblend version.

Team this option with @option{--verbose} to inquire configuration
details like the extra features that have been compiled in.

@item -w
@itemx --wrap=@var{MODE}
@opindex -w
@opindex --wrap
@cindex 360@textdegree{} panoramas
@cindex wrap around
Blend around the boundaries of the panorama.

With this option Enblend treats the panorama of width@tie{}@math{w}
and height@tie{}@math{h} as an infinite data structure, where each
pixel@tie{}@math{P(x, y)} of the input images represents the set of
pixels@tie{}@math{S_P(x, y)}@footnote{Solid-state physicists will be
reminded of the
@uref{http://@/en.wikipedia.org/@/wiki/@/Born-von_Karman_boundary_condition},
@sc{Born}-@sc{von K@'arm@'an} boundary condition.}.

@var{MODE} takes the following values:

@table @samp
@item none
@itemx open
This is a ``no-op''; it has the same effect as not giving
@option{--wrap} at all.  The set of input images is considered open at
its boundaries.

@item horizontal
Wrap around horizontally:
@ifinfo
@display
@math{S_P(x, y) = @{P(x + m * w, y): m in Z@}.}
@end display
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <mrow>
        <msub>
            <mi>S</mi>
            <mi>P</mi>
        </msub>
        <mfenced>
            <mi>x</mi>
            <mi>y</mi>
        </mfenced>
        <mo>=</mo>
        <mrow>
            <mo>&lcub;</mo>
            <mrow>
                <mi>P</mi>
                <mfenced>
                    <mrow>
                        <mi>x</mi>
                        <mo>+</mo>
                        <mi>m</mi>
                        <mo>&InvisibleTimes;</mo>
                        <mi>w</mi>
                    </mrow>
                    <mi>y</mi>
                </mfenced>
            </mrow>
            <mo>:</mo>
            <mrow>
                <mi>m</mi>
                <mtext>&ThickSpace;in&ThickSpace;</mtext>
                <mi>Z</mi>
            </mrow>
            <mo>&rcub;</mo>
        </mrow>
    </mrow>
</math>
@end html
@tex
$$
    S_P(x, y) = \{P(x + m w, y): m \in Z\}.
$$
@end tex
This is useful for 360@textdegree{} horizontal panoramas as it
eliminates the left and right borders.

@item vertical
Wrap around vertically:
@ifinfo
@display
@math{S_P(x, y) = @{P(x, y + n * h): m in Z@}.}
@end display
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <mrow>
        <msub>
            <mi>S</mi>
            <mi>P</mi>
        </msub>
        <mfenced>
            <mi>x</mi>
            <mi>y</mi>
        </mfenced>
        <mo>=</mo>
        <mrow>
            <mo>&lcub;</mo>
            <mrow>
                <mi>P</mi>
                <mfenced>
                    <mi>x</mi>
                    <mrow>
                        <mi>y</mi>
                        <mo>+</mo>
                        <mi>n</mi>
                        <mo>&InvisibleTimes;</mo>
                        <mi>h</mi>
                    </mrow>
                </mfenced>
            </mrow>
            <mo>:</mo>
            <mrow>
                <mi>n</mi>
                <mtext>&ThickSpace;in&ThickSpace;</mtext>
                <mi>Z</mi>
            </mrow>
            <mo>&rcub;</mo>
        </mrow>
    </mrow>
</math>
@end html
@tex
$$
    S_P(x, y) = \{P(x, y + n h): n \in Z\}.
$$
@end tex
This is useful for 360@textdegree{} vertical panoramas as it
eliminates the top and bottom borders.

@item both
@itemx horizontal+vertical
@itemx vertical+horizontal
Wrap around both horizontally and vertically:
@ifinfo
@display
@math{S_P(x, y) = @{P(x + m * w, y + n * h): m, n in Z@}.}
@end display
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML">
    <mrow>
        <msub>
            <mi>S</mi>
            <mi>P</mi>
        </msub>
        <mfenced>
            <mi>x</mi>
            <mi>y</mi>
        </mfenced>
        <mo>=</mo>
        <mrow>
            <mo>&lcub;</mo>
            <mrow>
                <mi>P</mi>
                <mfenced>
                    <mrow>
                        <mi>x</mi>
                        <mo>+</mo>
                        <mi>m</mi>
                        <mo>&InvisibleTimes;</mo>
                        <mi>w</mi>
                    </mrow>
                    <mrow>
                        <mi>y</mi>
                        <mo>+</mo>
                        <mi>n</mi>
                        <mo>&InvisibleTimes;</mo>
                        <mi>h</mi>
                    </mrow>
                </mfenced>
            </mrow>
            <mo>:</mo>
            <mrow>
                <mrow>
                    <mi>m</mi>
                    <mo>,</mo>
                    <mi>n</mi>
                </mrow>
                <mtext>&ThickSpace;in&ThickSpace;</mtext>
                <mi>Z</mi>
            </mrow>
            <mo>&rcub;</mo>
        </mrow>
    </mrow>
</math>
@end html
@tex
$$
    S_P(x, y) = \{P(x + m w, y + n h): m, n \in Z\}.
$$
@end tex
In this mode both, left and right borders as well as top and bottom
borders are eliminated.
@end table

Specifying @option{--wrap} without @var{MODE} selects horizontal
wrapping.

Version@tie{}@value{VERSION} of Enblend, the one described here, does
not blend neither zenith nor or nadir, so you may still see some seams
in these areas.

@item -x
@opindex -x
Checkpoint partial results to the output file after each blending
step.
@end table


@node Extended Options
@section Extended Options
@cindex options, extended

Extended options control the image cache, the color model, and the
cropping of the output image.

@table @code
@item -b @var{BLOCKSIZE}
@opindex -b
@cindex image cache, block size
Set the @var{BLOCKSIZE} in kilobytes (@acronym{KB}) of Enblend's image
cache.

This is the amount of data that Enblend will move to and from the disk
in one go.  The default is 2048@dmn{KB}, which should be ok for most
systems.

See @ref{Tuning Memory Usage} for details.

@item -c
@opindex -c
@cindex color appearance model
@cindex @acronym{CIECAM02}
Use the @acronym{CIECAM02} color appearance model for blending colors.

@cindex @acronym{ICC} profile
@cindex profile, @acronym{ICC}
@cindex @acronym{sRGB} color space
@cindex color space, @acronym{sRGB}
The input files should have embedded @acronym{ICC} profiles if this
option is specified.  If no @acronym{ICC} profile is present, Enblend
will assume that the image uses the @acronym{sRGB} color space.  The
difference between this option and Enblend's default color blending
algorithm is very slight and will be only noticeable when areas of
different primary colors are blended together.

@item -d
@itemx --depth=@var{DEPTH}
@opindex -d
@opindex --depth
@cindex bits per channel
@cindex channel width
Force the number of bits per channel and the numeric format of the
output image.

Enblend always uses a smart way to change the channel depth to assure
highest image quality (at the expense of memory) whether
requantization is implicit because of the output format or explicit
with option@tie{}@option{--depth}.

@itemize
@item
If the output-channel width is larger than the input-channel width of
the input images, the input images' channels are widened to the output
channel width immediately after loading, this is, as soon as possible.
Enblend then performs all blending operations at the output-channel
width, thereby preserving minute color details which can appear in the
blending areas.

@item
If the output-channel width is smaller than the input-channel width of
the input images, the output image's channels are narrowed only right
before it is written to disk, this is, as late as possible.  Thus the
data benefits from the wider input channels for the longest time.
@end itemize

All @var{DEPTH} specifications are valid in lowercase as well as
uppercase letters.  For integer format use

@table @asis
@item @code{8}, @code{uint8}
Unsigned 8@dmn{bit}; range: 0..255
@item @code{int16}
Signed 16@dmn{bit}; range: @minus{}32768..32767
@item @code{16}, @code{uint16}
Unsigned 16@dmn{bit}; range: 0..65535
@item @code{int32}
Signed 32@dmn{bit}; range: @minus{}2147483648..2147483647
@item @code{32}, @code{uint32}
Unsigned 32@dmn{bit}; range: 0..4294967295
@end table

For floating-point format use

@c Minimum positive normalized value: 2^(2 - 2^k)
@c Epsilon: 2^(1 - n)
@c Maximum finite value: (1 - 2^(-n)) * 2^(2^k)

@table @asis
@c IEEE single: 32 bits, n = 24, k = 32 - n - 1 = 7
@item @code{r32}, @code{real32}, @code{float}
@cindex @acronym{IEEE754} single precision float
@cindex single precision float, @acronym{IEEE754}
@acronym{IEEE754} single precision floating-point, 32@dmn{bit} wide,
24@dmn{bit} significant
@itemize
@item
Minimum normalized value: @semilog{1.2, -38}
@item
Epsilon: @semilog{1.2, -7}
@item
Maximum finite value: @semilog{3.4, 38}
@end itemize

@c IEEE double: 64 bits, n = 53, k = 64 - n - 1 = 10
@item @code{r64}, @code{real64}, @code{double}
@cindex @acronym{IEEE754} double precision float
@cindex double precision float, @acronym{IEEE754}
@acronym{IEEE754} double precision floating-point, 64@dmn{bit} wide,
53@dmn{bit} significant
@itemize
@item
Minimum normalized value: @semilog{2.2, -308}
@item
Epsilon: @semilog{2.2, -16}
@item
Maximum finite value: @semilog{1.8, 308}
@end itemize
@end table

If the requested @var{DEPTH} is not supported by the output file
format, Enblend warns and chooses the @var{DEPTH} that matches best.

@cindex @acronym{OpenEXR}, data format
The @acronym{OpenEXR} data format is treated as
@acronym{IEEE754}@tie{}float internally.  Externally, this is on disk,
@acronym{OpenEXR} data is represented by ``half'' precision
floating-point numbers.

@c ILM half: 16 bits, n = 10, k = 16 - n - 1 = 5
@cindex @acronym{OpenEXR}, half precision float
@cindex half precision float, @acronym{OpenEXR}
@uref{http://@/www.openexr.com/@/about.html#features,
@acronym{OpenEXR}} half precision floating-point, 16@dmn{bit} wide,
10@dmn{bit} significant
@itemize
@item
Minimum normalized value: @semilog{9.3, -10}
@item
Epsilon: @semilog{2.0, -3}
@item
Maximum finite value: @semilog{4.3, 9}
@end itemize

@item -f @var{WIDTH}x@var{HEIGHT}
@itemx -f @var{WIDTH}x@var{HEIGHT}+x@var{XOFFSET}+y@var{YOFFSET}
@opindex -f
@cindex output image, set size of
Set the size of the output image manually to
@var{WIDTH}@classictimes{}@var{HEIGHT}.  Optionally specify the
@var{X-OFFSET} and @var{Y-OFFSET}, too.

@pindex nona @r{(Hugin)}
@pindex hugin
This option is useful when the input images are cropped @acronym{TIFF}
files, such as those produced by @command{nona}.  The stitcher
@command{nona} is part of Hugin.  @xref{Helpful Programs}.

@item -g
@opindex -g
@cindex alpha channel, associated
Save alpha channel as ``associated''.  See the
@uref{http://@/www.awaresystems.be/@/imaging/@/tiff/@/tifftags/@/extrasamples.html,
@acronym{TIFF} documentation} for an explanation.

@pindex gimp
@pindex cinepaint
Gimp (before version@tie{}2.0) and Cinepaint (@pxref{Helpful
Programs}) exhibit unusual behavior when loading images with
unassociated alpha channels.  Use option @option{-g} to work around
this problem.  With this flag Enblend creates the output image with
the associated alpha tag set, even though the image is really
unassociated alpha.

@item --gpu
@opindex --gpu
@cindex graphics processing unit
@cindex @acronym{GPU} (Graphics Processing Unit)
Use the graphics card -- in fact the graphics processing unit
(@acronym{GPU}) -- to accelerate some computations.

This is an experimental feature that may not work on all systems.  In
this version of Enblend, @value{VERSION}, only mask optimization
strategy@tie{}1 benefits from this option.

Note that @acronym{GPU}-support must have been compiled in the Enblend
binary for this option being available.  Find out about this feature
with @code{enblend --version --verbose}.

@item -m @var{CACHESIZE}
@opindex -m
@cindex image cache, cache size
Set the @var{CACHESIZE} in megabytes (@acronym{MB}) of Enblend's image
cache.

This is the amount of memory Enblend will use for storing image data
before swapping to disk.  The default is 1024@dmn{MB} which is good
for systems with 3--4@dmn{gigabytes} (@acronym{GB}) of @acronym{RAM}.

See @ref{Tuning Memory Usage} for details.
@end table


@node Mask Generation Options
@section Mask Generation Options
@cindex options, mask generation

These options control the generation and the usage of masks.

@table @code
@item --anneal=@var{TAU}[:@var{DELTA-E-MAX}[:@var{DELTA-E-MIN}[:@var{K-MAX}]]]
@opindex --anneal
@cindex optimize, anneal parameters
@cindex anneal parameters
@cindex simulated annealing optimizer
@cindex optimizer, simulated annealing
Set the parameters of the Simulated Annealing optimizer used in
Optimizer Strategy@tie{}1 (see @ref{Table:optimizer-strategies}).

@table @var
@item TAU
@var{TAU} is the temperature reduction factor in the Simulated
Annealing; it also can be thought of as ``cooling factor''.  The
closer @var{TAU} is to one the more accurate the annealing run will be
and the longer it will take.

Append a percent sign (@samp{%}) to specify @var{TAU} as a percentage.

Valid range:
@ifinfo
0 < @var{TAU} < 1.
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mrow>
        <mn>0</mn>
        <mo>&lt;</mo>
        <mi mathvariant="italic">TAU</mi>
        <mo>&lt;</mo>
        <mn>1</mn>
        <mtext>.</mtext>
    </mrow>
</math>
@end html
@tex
$0 < \mathit{TAU} < 1$.
@end tex

The default is 0.75; values around 0.95 are reasonable.  Usually,
slower cooling results in more converged points.

@item DELTA-E-MAX
@itemx DELTA-E-MIN
@var{DELTA-E-MAX} and @var{DELTA-E-MIN} are the maximum and minimum
cost change possible by any single annealing move.

Valid range:
@ifinfo
0 < DELTA-E-MIN < DELTA-E-MAX.
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mrow>
        <mn>0</mn>
        <mo>&lt;</mo>
        <mi mathvariant="italic">DELTA-E-MIN</mi>
        <mo>&lt;</mo>
        <mi mathvariant="italic">DELTA-E-MAX</mi>
        <mtext>.</mtext>
    </mrow>
</math>
@end html
@tex
$0 < \mathit{DELTA-E-MIN} < \mathit{DELTA-E-MAX}$.
@end tex

In particular they determine the initial and final annealing
temperatures according to:
@ifinfo
@display
                   DELTA-E-MAX
T_initial = ------------------------
            log(K-MAX / (K-MAX - 2))

                DELTA-E-MIN
T_final = ------------------------
          log(K-MAX^2 - K-MAX - 1)
@end display
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mtable>
        <mtr>
            <mtd>
                <mrow>
                    <msub>
                        <mi mathvariant="italic">T</mi>
                        <mi mathvariant="roman">initial</mi>
                    </msub>
                    <mo>=</mo>
                    <mfrac>
                        <mi mathvariant="italic">DELTA-E-MAX</mi>
                        <mrow>
                            <mo>log</mo>
                            <mo>&ApplyFunction;</mo>
                            <mo>(</mo>
                            <mrow>
                                <mi mathvariant="italic">K-MAX</mi>
                                <mo>/</mo>
                                <mo>(<mo>
                                <mrow>
                                    <mi mathvariant="italic">K-MAX</mi>
                                    <mo>-</mo>
                                    <mn>2</mn>
                                </mrow>
                                <mo>)<mo>
                            </mrow>
                            <mo>)</mo>
                        </mrow>
                    </mfrac>
                </mrow>
            </mtd>
        </mtr>

        <mtr>
            <mtd>
                <mrow>
                    <msub>
                        <mi mathvariant="italic">T</mi>
                        <mi mathvariant="roman">final</mi>
                    </msub>
                    <mo>=</mo>
                    <mfrac>
                        <mi mathvariant="italic">DELTA-E-MIN</mi>
                        <mrow>
                            <mo>log</mo>
                            <mo>&ApplyFunction;</mo>
                            <mo>(</mo>
                            <mrow>
                                <msup>
                                    <mi mathvariant="italic">K-MAX</mi>
                                    <mn>2</mn>
                                </msup>
                                <mo>-</mo>
                                <mi mathvariant="italic">K-MAX</mi>
                                <mo>-</mo>
                                <mn>1</mn>
                            </mrow>
                            <mo>)</mo>
                        </mrow>
                    </mfrac>
                </mrow>
            </mtd>
        </mtr>
    </mtable>
</math>
@end html
@tex
$$\eqalign{
  T_{\mathrm{initial}} & =
    {\mathit{DELTA-E-MAX} \over {\log(\mathit{K-MAX} / (\mathit{K-MAX} - 2))}} \cr
  T_{\mathrm{final}} & =
    {\mathit{DELTA-E-MIN} \over {\log(\mathit{K-MAX\/}^2 - \mathit{K-MAX} - 1)}} \cr
}$$
@end tex

The defaults are: @var{DELTA-E-MAX}: 7000 and @var{DELTA-E-MIN}: 5.

@item K-MAX
@var{K-MAX} is the maximum number of ``moves'' the optimizer will make
for each line segment.  Higher values more accurately sample the state
space at the expense of a higher computation cost.

Valid range:
@ifinfo
@var{K-MAX} @geq{} 3.
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mrow>
        <mi mathvariant="italic">K-MAX</mi>
        <mo>&ge;</mo>
        <mn>3</mn>
        <mtext>.</mtext>
    </mrow>
</math>
@end html
@tex
$\mathit{K-MAX} \ge 3$.
@end tex

The default is 32.  Values around 100 seem reasonable.
@end table

@item --coarse-mask[=@var{FACTOR}]
@opindex --coarse-mask
@cindex mask, coarse
@cindex coarse mask
Use a scaled-down version of the input images to create the seam line.
This option reduces the number of computations necessary to compute
the seam line and the amount of memory necessary to do so.  It is the
default.

If omitted @var{FACTOR} defaults to 8, this means,
option@tie{}@option{--coarse-mask} shrinks the overlapping
@emph{areas} by a factor of 64.  With @var{FACTOR}@tie{}=@tie{}8 the
total memory allocated during a run of Enblend shrinks approximately
by 80% and the maximum amount of memory in use at a time is decreased
to 60% (Enblend compiled with image cache) or 40% (Enblend compiled
without image cache).

Valid range: @var{FACTOR} = 1, 2, 3,@dots{}.

Also see @ref{Table:mask-generation}.

@float Table,Table:mask-generation
@multitable @columnfractions 0.2 0.35 0.35
@headitem @tab @code{--no-optimize} @tab @code{--optimize}

@item @code{--fine-mask}
@c no opt
@tab
Use @acronym{NFT} mask.

@c opt
@tab
Vectorize @acronym{NFT} mask, optimize vertices with simulated
annealing and @sc{Dijkstra's} shortest path algorithm, fill vector
contours.

@item @code{--coarse-mask}
@c no opt
@tab
Scale down overlap region, compute @acronym{NFT} mask and vectorize
it, fill vector contours.

@c opt
@tab
Scale down overlap region, vectorize @acronym{NFT} mask, optimize
vertices with simulated annealing and @sc{Dijkstra's} shortest path
algorithm, fill vector contours.
@end multitable

@caption{Various options that control the generation of masks.  All
mask computations are based on the Nearest-Feature Transformation
(@acronym{NFT}) of the overlap region.}

@shortcaption{Mask generation options}

@cindex nearest-feature transform (@acronym{NFT})
@cindex mask, generation
@end float

@item --dijkstra=@var{RADIUS}
@opindex --dijkstra
@cindex @sc{Dijkstra} radius
@cindex radius, @sc{Dijkstra}
Set the search @var{RADIUS} of the @sc{Dijkstra} Shortest Path
algorithm used in Optimizer Strategy@tie{}2 (see
@ref{Table:optimizer-strategies}).

A small value prefers straight line segments and thus shorter seam
lines.  Larger values instruct the optimizer to let the seam line take
more detours when searching for the best seam line.

Valid range:
@ifinfo
@var{RADIUS} @geq{} 0.
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mrow>
        <mi mathvariant="italic">RADIUS</mi>
        <mo>&ge;</mo>
        <mn>0</mn>
        <mtext>.</mtext>
    </mrow>
</math>
@end html
@tex
$\mathit{RADIUS} \ge 0$.
@end tex

Default: 25@dmn{pixels}.

@item --fine-mask
@opindex --fine-mask
@cindex mask, fine
@cindex fine mask
Instruct Enblend to employ the full-size images to create the seam
line, which can be slow.  Use this option, for example, if you have
very narrow overlap regions.

Also see @ref{Table:mask-generation}.

@item --load-mask[=@var{IMAGE-TEMPLATE}]
@opindex --load-mask
@cindex mask, load
@cindex load mask
Instead of generating masks, use those in @var{IMAGE-TEMPLATE}.  The
default is @file{mask-%n.tif}.

See @option{--save-mask} below for details.

@item --mask-vectorize=@var{DISTANCE}
@opindex --mask-vectorize
@cindex mask, vectorization distance
Set the mask vectorization @var{DISTANCE} Enblend uses to partition
each seam.  Thus, break down the seam to segments of length
@var{DISTANCE} each.

If Enblend uses a coarse mask (@option{--coarse-mask}) or Enblend
optimizes (@option{--optimize}) a mask it vectorizes the initial seam
line before performing further operations.  See
@ref{Table:mask-generation} for the precise conditions.
@var{DISTANCE} tells Enblend how long to make each of the line
segments called vectors here.

The unit of @var{DISTANCE} is pixels unless it is a percentage as
explained in the next paragraph.  In fine masks one mask pixel
corresponds to one pixel in the input image, whereas in coarse masks
one pixel represents 8@tie{}pixels in the input image.

Append a percentage sign (@samp{%}) to @var{DISTANCE} to specify the
segment length as a fraction of the diagonal of the rectangle
including the overlap region.  Relative measures do not depend on
coarse or fine masks, they are recomputed for each mask.  Values
around 5%--10% are a good starting point.

This option massively influences the mask generation process!  Large
@var{DISTANCE} values lead to shorter, straighter, less wiggly, less
baroque seams that are on the other hand less optimal, because they
run through regions of larger image mismatch instead of avoiding them.
Small @var{DISTANCE} values give the optimizers more possibilities to
run the seam around high mismatch areas.

@cindex seam line, loops
@cindex loops in seam line
What should @emph{never} happen though, are loops in the seam line.
Counter loops with larger vectorization @var{DISTANCE}s, @var{TAU}s
(in option@tie{}@option{--anneal}) that are closer to one, and
blurring of the difference image with
option@tie{}@option{--smooth-difference}.  Use
option@tie{}@option{--visualize} to check the results.

Valid range:
@ifinfo
@var{DISTANCE} @geq{} 4.
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mrow>
        <mi mathvariant="italic">DISTANCE</mi>
        <mo>&ge;</mo>
        <mn>4</mn>
        <mtext>.</mtext>
    </mrow>
</math>
@end html
@tex
$\mathit{DISTANCE} \ge 4$.
@end tex
Enblend limits @var{DISTANCE} so that it never gets below 4 even if it
has been given as a percentage.  The user will be warned in such
cases.

Default: 4@dmn{pixels} for coarse masks and 20@dmn{pixels} for fine
masks.

@item --no-optimize
@opindex --no-optimize
@cindex optimize seam
@cindex seam optimization
Turn off seam line optimization.  Combined with
option@tie{}@option{--fine-mask} this will produce the same type of
mask as Enblend version@tie{}2.5, namely the result of a
@cindex nearest-feature transform (@acronym{NFT})
Nearest-Feature Transform (@acronym{NFT}).@footnote{@sc{Muhammad
H. Alsuwaiyel} and @sc{Marina Gavrilova}, ``On the Distance Transform
of Binary Images'', Proceedings of the International Conference on
Imaging Science, Systems, and Technology, June 2000, @abbr{Vols@.} I
and II, pages 83--86.}

Also see @ref{Table:mask-generation}.

@item --optimize
@opindex --optimize
@cindex optimize seam
@cindex seam optimization
Use a two-strategy approach to route the seam line around mismatches
in the overlap region.  This is the default.
@ref{Table:optimizer-strategies} explains these strategies; also see
@ref{Table:mask-generation}.

@float Table,Table:optimizer-strategies
@cindex optimize strategy

@table @asis
@item Stragegy 1: Simulated Annealing
Tune with option@tie{}@code{--anneal} = @var{TAU} : @var{DELTA-E-MAX}
: @var{DELTA-E-MIN} : @var{K-MAX}.

@uref{http://@/en.wikipedia.org/@/wiki/@/Simulated_annealing,
Simulated-Annealing}


@item Stragegy 2: @sc{Dijkstra} Shortest Path
Tune with option@tie{}@code{--dijkstra} = @var{RADIUS}.

@uref{http://@/en.wikipedia.org/@/wiki/@/Dijkstra_algorithm,
@sc{Dijkstra} algorithm}

@end table
@caption{Enblend's two strategies to optimize the seam lines between
images.}

@shortcaption{optimizer strategies}
@end float

@item --save-mask[=@var{IMAGE-TEMPLATE}]
@opindex --save-mask
@cindex mask, save
@cindex save mask
Save the generated masks to @var{IMAGE-TEMPLATE}.  The default is
@file{mask-%n.tif}.  Enblend saves masks as 8@dmn{bit} grayscale
(single channel) images.  For accuracy we recommend to choose a
lossless format.

Use this option if you wish to edit the location of the seam line by
hand.  This will give you images of the right sizes that you can edit
to make your changes.  Later, use @option{--load-mask} to blend the
project with your custom seam lines.

@var{IMAGE-TEMPLATE} defines a template that is expanded for each
input file.  In a template a percent sign (@samp{%}) introduces a
variable part.  All other characters are copied literally.  Lowercase
letters refer to the name of the respective input file, whereas
uppercase ones refer to the name of the output file (@pxref{Common
Options}).  @ref{Table:mask-template-characters} lists all variables.

A fancy mask filename template could look like this:

@example
%D/mask-%02n-%f.tif
@end example

It puts the mask files into the same directory as the output file
(@samp{%D}), generates a two-digit index (@samp{%02n}) to keep the
mask files nicely sorted, and decorates the mask filename with the
name of the associated input file (@samp{%f}) for easy recognition.

@item --smooth-difference=@var{RADIUS}
@opindex --smooth-difference
@cindex smooth difference image
@cindex blur difference image
Smooth the difference image prior to seam-line optimization to get a
shorter and -- on the length scale of @var{RADIUS} -- also a
straighter seam-line.  The default is not to smooth.

If @var{RADIUS} is larger than zero Enblend blurs the difference
images of the overlap regions with a @sc{Gaussian} filter having a
radius of @var{RADIUS}@dmn{pixels}.  Values of 0.5 to 1.5@dmn{pixels}
for @var{RADIUS} are good starting points; use
option@tie{}@option{--visualize} to directly judge the effect.

When using this option in conjunction with
@tie{}@option{--coarse-mask}=@var{FACTOR}, keep in mind that the
smoothing occurs @emph{after} the overlap regions have been shrunken.
Thus, blurring affects a @var{FACTOR}@classictimes{}@var{FACTOR} times
larger area in the original images.

Valid range:
@ifinfo
0 @leq{} @var{RADIUS}.
@end ifinfo
@html
<math xmlns="http://www.w3.org/1998/Math/MathML" display="inline">
    <mrow>
        <mn>0</mn>
        <mo>&le;</mo>
        <mi mathvariant="italic">RADIUS</mi>
        <mtext>.</mtext>
    </mrow>
</math>
@end html
@tex
$0 \le \mathit{RADIUS}$.
@end tex

@item --visualize[=@var{VISUALIZE-TEMPLATE}]
@opindex --visualize
@cindex mask, optimization visualization
@cindex visualization of mask optimization
Create an image according to @var{VISUALIZE-TEMPLATE} that visualizes
the mask optimization process.  The default is @file{vis-%n.tif}.

This shows Enblend's view of the overlap region and how it decided to
route the seam line.  If you are experiencing artifacts or unexpected
output, it may be useful to include this visualization image in your
bug report.

@var{VISUALIZE-TEMPLATE} defines a template that is expanded for each
input file.  In a template a percent sign (@samp{%}) introduces a
variable part.  All other characters are copied literally.  Lowercase
letters refer to the name of the respective input file, whereas
uppercase ones refer to the name of the output file (@pxref{Common
Options}).  @ref{Table:mask-template-characters} lists all variables.

@sp 1
@noindent
@strong{Visualization File}
@need 150
The visualization file shows the symmetric difference of the pixels in
the rectangular region where two images overlap.  Enblend paints
non-overlapping parts of the image pair with dark red.

The optimizer's samples are shown in blue.  If a sample is the first
of a line segment it is painted in light green; non-first line
segments are drawn in darker green.  Cyan points indicate state space
samples inside the @sc{Dijkstra} radius.  Non-converged points are
drawn in magenta color.  The final seam line is shown in bright
yellow.
@end table

@page

@include mask-template-characters.texi


@node Understanding Masks
@chapter Understanding Masks
@cindex understanding masks
@cindex masks, understanding

@include understanding-masks.texi


@node Tuning Memory Usage
@chapter Tuning Memory Usage
@cindex memory, tuning usage of
@opindex -b
@opindex -m

@include tuning-memory-usage.texi


@node Helpful Programs
@chapter Helpful Additional Programs
@cindex helpful programs
@cindex programs, helpful additional

@include helpful-programs.texi


@node Authors
@appendix Authors
@cindex authors, list of

@include authors.texi


@node FDL
@appendix @acronym{GNU} Free Documentation License
@cindex free documentation license (@acronym{FDL})
@cindex @acronym{GNU} free documentation license

@include fdl.texi


@c
@c End of Document
@c

@node Program Index
@unnumbered Program Index
@cindex program index
@cindex index, program

@printindex pg


@node Option Index
@unnumbered Option Index
@cindex option index
@cindex index, option

@printindex op


@node General Index
@unnumbered General Index
@cindex general index
@cindex index, general

@printindex cp

@bye
